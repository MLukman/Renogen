{% extends "renobase.twig" %}
{% import _self as actform %}

{% block content %}
	{% set is_existing = (activity.id|default(null) is not empty) %}
	<h1 class="ui header">
		<i class="ui idea icon"></i>{{activity.item.displayTitle}} &raquo; 
		{% if is_existing %}Edit{% else %}Add{% endif %} activity
	</h1>

	{% if activity.item.deployment.project.templates.count == 0 %}
		<div class="ui error message">
			There is no activity template found for project '{{activity.item.deployment.project.title}}'.
			Please contact administrator.
		</div>
	{% endif %}

	<form method="POST">
		<div class="ui form">
			{% if activity.template is empty %}
				<div class="ui required field basic segment">
					<label class="ui top attached large label">Template</label>
					<select name="template" class="ui dropdown">
						<option value="">-- Select one --</option>
						{% for template in activity.item.deployment.project.templates %}
							<option value="{{template.id}}">{{template.title}}</option>
						{% endfor %}
					</select>
					{{ m.fieldError(errors|default([]), 'template') }}
				</div>
				<div class="ui field">
					<input type="submit" class="ui submit primary button" name="_action" value="Next" />
					<a href="{{cancel_path|default('javascript:window.history.go(-1)')}}" class="ui secondary button">Cancel</a>
				</div>
			{% else %}
				<h2 class="ui header">Template: {{activity.template.title}}</h2>
				<input type="hidden" name="template" value="{{activity.template.id}}" />
				<div class="ui field basic segment required">
					<label class="ui top attached large label">Stage</label>
					{% set stages = { '-1':'Pre Deployment', '0': 'During Deployment', '1': 'Post Deployment' } %}
					<div class="inline fields">
						{% for stage,label in stages %}
							<div class="field">
								<div class="ui radio checkbox">
									<input id="stage-{{stage}}" type="radio" name="stage" value="{{stage}}" {% if stage == activity.stage|default(0) %}checked="checked"{% endif %}>
									<label for="stage-{{stage}}">{{label}}</label>
								</div>
							</div>
						{% endfor %}
					</div>
				</div>
				{{ actform.activityConfigForm(activity.template, activity, errors|default([])) }}
				<div class="ui field">
					<input type="submit" class="ui submit primary button" name="_action" value="{% if is_existing %}Save{% else %}Create{% endif %} activity" />
					<a href="{{cancel_path|default('javascript:window.history.go(-1)')}}" class="ui secondary button">Cancel</a>
					{% if is_existing %}
						<input type="submit" class="ui red right floated button" name="_action" value="Delete"
							   onclick="return confirm('Are you sure you want to delete?')" />
					{% endif %}
				</div>
			{% endif %}
		</div>
	</form>

	<p>&nbsp;</p>
	{{ r.timestamps(activity) }}
{% endblock %}

{% macro activityConfigForm(template, activity, errors) %}
	{% import "base.twig" as m %}
	{% set templateClass = template.templateClass() %}
	{% for param,parameter in templateClass.getParameters() %}
		{% if parameter.activityRequireInputs(template.parameters[param]|default(null)) %}
			<div class="ui field basic segment {% if parameter.activityRequired %}required{% endif %}">
				<label for="parameters-{{param}}" class="ui top attached large label">{{parameter.activityLabel(template.parameters)}}</label>
				{% if parameter.type in ['freetext', 'regextext'] %}
					<input id="parameters-{{param}}" type="text" name="parameters[{{param}}]" placeholder="{{parameter.activityDescription}}" value="{{activity.parameters[param]|default(null)}}" />
					{{ m.fieldError(errors|default([]), 'parameters.' ~ param) }}
				{% elseif parameter.type == 'multilinetext' %}
					<textarea id="parameters-{{param}}" name="parameters[{{param}}]" placeholder="{{parameter.activityDescription}}">{{activity.parameters[param]|default(null)}}</textarea>
					{{ m.fieldError(errors|default([]), 'parameters.' ~ param) }}
				{% elseif parameter.type == 'dropdown' %}
					{% if template.parameters[param]|length == 1 and parameter.activityRequired %}
						{% set v = (template.parameters[param]|keys)[0] %}
						<div>{{template.parameters[param][v]}}</div>
						<input type="hidden" name="parameters[{{param}}]" value="{{v}}" />
					{% else %}
						<select id="parameters-{{param}}" name="parameters[{{param}}]" class="ui search dropdown">
							<option value="">-- Please select --</option>
							{% for v,t in template.parameters[param] %}
								<option value="{{v}}" {% if v == activity.parameters[param]|default(null) %}selected="selected"{% endif %}>{{t}}</option>
							{% endfor %}
						</select>
					{% endif %}
					{{ m.fieldError(errors|default([]), 'parameters.' ~ param) }}
				{% elseif parameter.type == 'multiselect' %}
					<div class="grouped fields">
							{% for v,t in template.parameters[param] %}
							<div class="field">
								<div class="ui checkbox">
									<input type="checkbox" value="{{v}}" name="parameters[{{param}}][]" {% if v in activity.parameters[param]|default([]) %}checked="checked"{% endif %} />
									<label>{{t}}</label>
								</div>
							</div>
						{% endfor %}
					</div>
				{% elseif parameter.type == 'multifreetext' %}
					{% if template.parameters[param]|length > 0 %}
						<div class="ui form">
							{% for k,lbl in template.parameters[param] %}
								{% set label = (lbl|last == '*' ? lbl|slice(0,-1) : lbl) %}
								<div class="{% if lbl|last == '*' %}required {% endif %}field">
									<label for="parameters-{{param}}-{{k}}">{{label}}</label>
									<input id="parameters-{{param}}-{{k}}" type="text" name="parameters[{{param}}][{{k}}]" value="{{activity.parameters[param][k]|default(null)}}" />
									{{ m.fieldError(errors|default([]), 'parameters.' ~ param ~ '.' ~ k) }}
								</div>
							{% endfor %}
						</div>
					{% else %}
						<p><em>-- Not required --</em></p>
					{% endif %}
				{% endif %}
			</div>
		{% endif %}
	{% endfor %}
{% endmacro %}