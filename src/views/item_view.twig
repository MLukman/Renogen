{% extends "renobase.twig" %}
{% import _self as mm %}

{% block head %}
    <script>
        function changeStatus(status) {
            $('#change_status_field').val(status);
            $('#change_status_next').text(status);
            $('#change_status_confirmation').modal('show');
        }
        $(function () {
            $('#change_status_dropdown')
                    .dropdown({
                        action: function (text, value, element) {
                            changeStatus(value);
                            $('#change_status_dropdown').dropdown('hide');
                        }
                    });
        });
    </script>
{% endblock %}

{% block content %}
    {% set params = controller.entityParams(item) %}
    {% set is_acl_approval = app.securilex.isGranted('approval',item.deployment.project) %}
    {% set is_acl_review = app.securilex.isGranted('review',item.deployment.project) %}
    {% set is_acl_entry = app.securilex.isGranted(['entry','review'],item.deployment.project) %}
    {% set is_acl_execute = app.securilex.isGranted(['execute','entry','review','approval'],item.deployment.project) %}
    {% set editable = app.securilex.isGranted(['entry','review'],item.deployment.project) and item.compareCurrentStatusTo('Pending Approval') < 0 %}
    {% set next_status = app.statemodel.getAvailableTransitions('item', item.deployment.project.userProjects.get(app.user().username).role, item.status) %}

    <h1 class="ui dividing header">
        <div>
            <small>
                <i class="ui calendar check o  icon"></i>{{item.deployment.displayTitle}} &raquo;
            </small>
        </div>
        <span>
            <i class="ui idea icon"></i>{{item.displayTitle}}
        </span>
        <div>
            {% if editable %}
                <a class="ui right floated button no-print" href="{{app.path('item_edit',controller.entityParams(item))}}"><i class="ui pencil icon"></i>Edit</a>
            {% endif %}

            {#
            {% if not item.submitted_date %}
                {% if is_acl_approval or is_acl_entry %}
                    <a class="ui right floated primary button" href="{{app.path('item_submit',params)}}"
                       onclick="javascript:return confirm('Submit this item for approval?');"><i class="ui send icon"></i>Submit for approval</a>
                {% endif %}
            {% elseif not item.approved_date %}
                {% if is_acl_approval %}
                    <button id="reject_button" class="ui right floated red button no-print"><i class="ui x icon"></i>Reject</button>
                    <div class="ui popup">
                        <form class="ui form center aligned basic segment" style="width: 400px" method="POST" action="{{app.path('item_reject',params)}}">
                            <div class="ui required field">
                                <label class="ui top attached large label">Rejection remark</label>
                                <textarea placeholder="Explain briefly why this item is to be rejected" name="remark"></textarea>
                            </div>
                            <div class="ui field">
                                <input class="ui red button" type="submit" value="Confirm reject" />
                            </div>
                        </form>
                    </div>
                    <a class="ui right floated primary button no-print" href="{{app.path('item_approve',params)}}"
                       onclick="javascript:return confirm('Approve this item for deployment?');"><i class="ui check icon"></i>Approve</a>
                {% endif %}
            {% else %}
                {% if is_acl_approval %}
                    <a class="ui right floated red button no-print" href="{{app.path('item_unapprove',params)}}"
                       onclick="javascript:return confirm('Unapprove this item?');"><i class="ui x icon"></i>Unapprove</a>
                {% endif %}
            {% endif %}
            #}
            <div class="ui labels">
                {{ r.itemCategoryLabel(item) }}
                {{ r.itemModulesLabel(item) }}
                {#{ r.itemStatusLabel(item, true) }#}
            </div>
        </div>
    </h1>

    {% if item.description %}
        <div class="ui info message">{{item.description|nl2br}}</div>
    {% endif %}

    <div class="ui mobile stackable grid">

        <div class="four wide column">
            <h2 class="ui top attached block header">
                Status: <span style="white-space: nowrap"><i class="ui {{ item.statusIcon() }} icon"></i>{{ item.status }}</span>
            </h2>
            <div class="ui attached secondary segment">
                <div class="ui top attached tabular menu">
                    <div class="active item" data-tab="status-progress">Progress</div>
                    <div class="item" data-tab="status-log">Log</div>
                </div>

                <div class="ui bottom attached tab segment active" data-tab="status-progress">
                    <div class="ui stackable ordered small vertical fluid steps">
                        {% set submitted = item.compareCurrentStatusTo('Pending Review') >= 0 %}
                        {% set reviewed = item.compareCurrentStatusTo('Pending Review') > 0 %}
                        {% set approved = item.compareCurrentStatusTo('Pending Approval') > 0 %}
                        {% set ready = item.compareCurrentStatusTo('Ready') >= 0 %}
                        {% set completed = item.compareCurrentStatusTo('Completed') >= 0 %}
                        {% set log_pending_review = item.getStatusLog('Pending Review') %}
                        {% set log_pending_approval = item.getStatusLog('Pending Approval') %}
                        {% set log_approved = item.getStatusLog('Approved') %}
                        <div class="{% if submitted %}completed{% else %}active{% endif %} step">
                            <div class="content">
                                {% if submitted %}
                                    <div class="title" style="text-decoration: line-through">
                                        {% if log_pending_review %}
                                            {{item.getStatusLogBefore(log_pending_review).status}}
                                        {% else %}
                                            Unsubmitted
                                        {% endif %}
                                    </div>
                                {% else %}
                                    <div class="title">{{item.status}}</div>
                                    <div class="description">User to change status to 'Pending Review'</div>
                                {% endif %}
                            </div>
                            {% if not submitted %}
                                {{ mm.changeStatusBox(next_status) }}
                            {% endif %}
                        </div>
                        <div class="{% if reviewed %}completed{% elseif submitted %}active{% endif %} step">
                            <div class="content">
                                {% if reviewed %}
                                    <div class="title" style="text-decoration: line-through">Pending Review</div>
                                {% else %}
                                    <div class="title">Pending Review</div>
                                    <div class="description">Reviewer to change status to 'Pending Approval'</div>
                                {% endif %}
                            </div>
                            {% if submitted and not reviewed %}
                                {{ mm.changeStatusBox(next_status) }}
                            {% endif %}
                        </div>
                        <div class="{% if approved %}completed{% elseif reviewed %}active{% endif %} step">
                            <div class="content">
                                {% if approved %}
                                    <div class="title" style="text-decoration: line-through">Pending Approval</div>
                                {% else %}
                                    <div class="title">Pending Approval</div>
                                    <div class="description">Approver to change status to 'Approved'</div>
                                {% endif %}
                            </div>
                            {% if reviewed and not approved %}
                                {{ mm.changeStatusBox(next_status) }}
                            {% endif %}
                        </div>
                        <div class="{% if ready %}completed{% elseif approved %}active{% endif %} step">
                            <div class="content">
                                {% if ready %}
                                    <div class="title" style="text-decoration: line-through">Approved</div>
                                {% else %}
                                    <div class="title">Approved</div>
                                    <div class="description">Release manager to approve at deployment level</div>
                                {% endif %}
                            </div>
                            {% if approved and not ready %}
                                {{ mm.changeStatusBox(next_status) }}
                            {% endif %}
                        </div>
                        <div class="{% if completed %}completed{% elseif ready %}active{% endif %} step">
                            <div class="content">
                                {% if completed %}
                                    <div class="title">Completed</div>
                                {% else %}
                                    <div class="title">Ready</div>
                                    <div class="description">System admin to execute deployment</div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
                <div class="ui bottom attached segment tab" data-tab="status-log">
                    <table class="ui very compact small sortable table">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Status</th>
                                <th>By</th>
                            </tr>
                        </thead>					
                        <tbody>
                            {% for log in item.status_logs %}
                                <tr>
                                    <td>
                                        <i class="calendar icon"></i>{{log.created_date|date('Y-m-d')}}
                                        <i class="clock icon"></i>{{log.created_date|date('H:i')}}
                                    </td>
                                    <td>{{log.status}}</td>
                                    <td>{{log.created_by.shortname}}</td>
                                </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <div class="eight wide column">
            <h2 class="ui header">
                <span>
                    <i class="ui add to cart icon"></i> Activities
                </span>
                {% if editable %}
                    <a class="ui right floated primary button no-print" href="{{app.path('activity_create',params)}}">
                        <i class="ui plus icon"></i>Add activity
                    </a>
                {% endif %}
            </h2>

            <table class="ui celled striped table">
                <thead>
                    <tr>
                        <th class="ui collapsing">#</th>
                        <th>Template</th>
                        <th>Description</th>
                            {% if editable %}
                            <th class="ui collapsing no-print">Action</th>
                            {% endif %}
                    </tr>
                </thead>
                <tbody>
                    {% for activity in item.activities %}
                        {% set description = activity.template.templateClass().describeActivityAsArray(activity) %}
                        <tr>
                            <td class="ui top aligned collapsing">{{loop.index}}</td>
                            <td class="ui top aligned">
                                {% if activity.stage < 0 %}
                                    <em>Pre Deployment &raquo;</em><br />
                                {% elseif activity.stage > 0 %}
                                    <em>Post Deployment &raquo;</em><br />
                                {% endif %}
                                {{activity.template.title}}
                            </td>
                            <td class="ui top aligned" style="max-width: 600px; overflow-x: auto;">
                                <div style="max-height: 400px; overflow-y: auto;">
                                    {{ r.arrayTable(description) }}
                                </div>
                            </td>
                            {% if editable %}
                                <td class="ui top aligned collapsing no-print">
                                    <a class="ui icon button" title="Edit" href="{{app.path('activity_edit',controller.entityParams(activity))}}">
                                        <i class="ui pencil icon"></i>
                                    </a>
                                </td>
                            {% endif %}
                        </tr>
                    {% else %}
                        <tr>
                            <td colspan="1000" class="center aligned">No activity has been defined</td>
                        </tr>
                    {% endfor %}
                </tbody>
            </table>

            <h2 class="ui header">
                <span>
                    <i class="ui attach icon"></i> Attachments
                </span>
                {% if editable %}
                    <a class="ui right floated primary button no-print" href="{{app.path('attachment_create',params)}}">
                        <i class="ui plus icon"></i>Add attachment
                    </a>
                {% endif %}
            </h2>

            <table class="ui celled striped table">
                <thead>
                    <tr>
                        <th class="ui collapsing">#</th>
                        <th>File Name &amp; Type</th>
                        <th>Description</th>
                        <th class="ui collapsing">File Size</th>
                            {% if editable %}
                            <th class="ui collapsing no-print">Action</th>
                            {% endif %}
                    </tr>
                </thead>
                <tbody>
                    {% for attachment in item.attachments %}
                        <tr>
                            <td class="ui collapsing">{{loop.index}}</td>
                            <td>
                                <a title="Download" href="{{app.path('attachment_download',controller.entityParams(attachment))}}">
                                    <strong>{{attachment.filename}}</strong>
                                </a>
                                <div>
                                    <small>{{attachment.mime_type}}</small>
                                </div>
                            </td>
                            <td>{{attachment.description}}</td>
                            <td class="ui collapsing">{{attachment.filesize}}</td>
                            {% if editable %}
                                <td class="ui collapsing no-print">
                                    <a class="ui icon button" title="Edit" href="{{app.path('attachment_edit',controller.entityParams(attachment))}}">
                                        <i class="ui pencil icon"></i>
                                    </a>
                                </td>
                            {% endif %}
                        </tr>
                    {% else %}
                        <tr>
                            <td colspan="1000" class="center aligned">No attachment has been uploaded</td>
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        <div class="four wide column">
            <div class="ui secondary segment">
                <h3 class="ui dividing header">
                    <i class="ui comments outline icon"></i> Comments
                </h3>

                <div class="ui comments">
                    {% for comment in item.comments %}
                        <div class="comment">
                            <div class="content">
                                {% if comment.created_by == app.userEntity() and comment.event is empty %}
                                    {% if comment.deleted_date %}
                                        <a class="ui right floated compact very tiny icon button" 
                                           href="{{app.path('item_comment_undelete',controller.entityParams(item)+{'comment':comment.id})}}" title="Undo delete"><i class="ui undo icon"></i>
                                        </a>
                                    {% else %}
                                        <a class="ui right floated compact very tiny icon button" 
                                           href="{{app.path('item_comment_delete',controller.entityParams(item)+{'comment':comment.id})}}" title="Delete"><i class="ui x icon"></i>
                                        </a>
                                    {% endif %}
                                {% endif %}
                                <a class="author">{{comment.created_by.getName()}}</a>
                                <div class="metadata">
                                    <span class="date">{{comment.created_date|date('d/m/Y h:ia')}}</span>
                                </div>
                                {% if comment.event %}
                                    <div class="text">
                                        <span class="ui right pointing label">{{comment.event}}</span> {{comment.text|nl2br}}
                                    </div>
                                {% elseif comment.deleted_date %}
                                    <div class="metadata">
                                        <em>&raquo; Deleted on {{comment.deleted_date|date('d/m/Y h:ia')}}</em>
                                    </div>
                                {% else %}
                                    <div class="text">
                                        {{comment.text|nl2br}}
                                    </div>
                                {% endif %}	
                            </div>
                        </div>
                    {% else %}
                        <em>No comments yet</em>
                    {% endfor %}
                    {% if is_acl_execute %}
                        <form class="ui center aligned form basic segment no-print" method="POST" action="{{app.path('item_comment_add',controller.entityParams(item))}}">
                            <h4 class="ui horizontal divider header">
                                Add comment
                            </h4>
                            <div class="field">
                                <textarea name="text" rows="3"></textarea>
                            </div>
                            <input class="ui secondary button" type="submit" name="_action" value="Post" />
                        </form>
                    {% endif %}
                </div>			
            </div>
        </div>

    </div>

    <script>
        $(function () {
            $('.menu .item')
                    .tab();
        });
    </script>

    <div id="change_status_confirmation" class="ui modal">
        <i class="close icon"></i>
        <div class="header">
            Change Status to <span id="change_status_next">next</span>
        </div>
        <form class="ui form basic segment" method="POST" action="{{app.path('item_change_status',params)}}">
            <div class="ui required field content">
                <label>Remark</label>
                <textarea placeholder="Please enter a remark" name="remark"></textarea>
            </div>
            <div class="actions">
                <input class="ui ok primary button" type="submit" value="Change Status" />
                <div class="ui cancel button">Cancel</div>
                <input id="change_status_field" type="hidden" name="new_status" value="" />
            </div>
        </form>
    </div>
{% endblock %}

{% macro changeStatus(v, i) %}
    <div class="ui left labeled button" tabindex="0" style="margin:5px">
        <a class="ui basic right pointing label">
            {% if i.class is defined %}Change{% else %}Revert{% endif %}
        </a>
        <div class="ui {{i.class|default(null)}} button" onclick="changeStatus({{v|json_encode|e('html_attr')}})">
            <i class="{{i.icon}} icon"></i> {{v}}
        </div>
    </div>
{% endmacro %}

{% macro changeStatusBox(next_status) %}
    {% import _self as mm %}
    {% if next_status|length > 0 %}
        <div class="ui info message">
            {% for v,i in next_status %}
                {{mm.changeStatus(v, i)}}<br />
            {% endfor %}
        </div>
    {% endif %}
{% endmacro %}