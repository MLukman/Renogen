{% extends "renobase.twig" %}
{% import _self as mm %}

{% block head %}
    <script>
        function changeStatus(status, required) {
        $('#change_status_field').val(status);
        $('#change_status_next').text(status);
        if (required) {
        $('#changeStatusRemarkField').addClass('required');
        $('#changeStatusRemarkRequired').val(1);
        } else {
        $('#changeStatusRemarkField').removeClass('required');
        $('#changeStatusRemarkRequired').val(0);
        }
        $('#change_status_confirmation').modal('show');
        }
        $(function () {
        $('#change_status_dropdown')
                .dropdown({
                action: function (text, value, element) {
                changeStatus(value);
                $('#change_status_dropdown').dropdown('hide');
                }
                });
        });
    </script>
{% endblock %}

{% block content %}
    {% set params = controller.entityParams(item) %}
    {% set is_acl_approval = app.securilex.isGranted('approval',item.deployment.project) %}
    {% set is_acl_review = app.securilex.isGranted('review',item.deployment.project) %}
    {% set is_acl_entry = app.securilex.isGranted(['entry','review'],item.deployment.project) %}
    {% set is_acl_execute = app.securilex.isGranted(['execute','entry','review','approval'],item.deployment.project) %}
    {% set editable = app.securilex.isGranted(['entry', 'approval'],item.deployment.project) and item.compareCurrentStatusTo('Go No Go') > 0 %}
    {% set next_status = app.statemodel.getAvailableTransitions('item', item.deployment.project.userProjects.get(app.user().username).role, item.status) %}

    <h1 class="ui dividing header">
        <div>
            <small>
                {{r.crumb_project(item.deployment.project, true)}} &raquo;
                {{r.crumb_deployment(item.deployment, true)}} &raquo;
            </small>
        </div>
        <span>
            <i class="ui idea icon"></i>{{item.displayTitle}}
        </span>
        <div>
            {% if editable %}
                <a class="ui right floated button no-print" href="{{app.path('item_edit',controller.entityParams(item))}}"><i class="ui pencil icon"></i>Edit</a>
            {% endif %}
            <div class="ui labels">
                {{ r.itemCategoryLabel(item) }}
                {{ r.itemModulesLabel(item) }}
            </div>
        </div>
    </h1>

    {% if item.description %}
        <div class="ui info message">{{item.description|nl2br}}</div>
    {% endif %}

    <div class="ui mobile stackable grid">

        <div class="four wide column">
            <h2 class="ui top attached block header">
                Status: <span style="white-space: nowrap"><i class="ui {{ item.statusIcon() }} icon"></i>{{ item.status }}</span>
            </h2>
            <div class="ui attached secondary segment">
                <div class="ui top attached tabular menu">
                    <div class="active item" data-tab="status-progress">Progress</div>
                    <div class="item" data-tab="status-log">Log</div>
                </div>

                <div class="ui bottom attached tab segment active" data-tab="status-progress">
                    <div class="ui stackable ordered small vertical fluid steps">
                        {% for s in item.deployment.project.item_statuses|keys %}
                            {% set prog = item.compareCurrentStatusTo(s) %}
                            <div class="{% if prog < 0 or item.status == 'Completed' %}completed{% endif %} {% if prog == 0 %}active{% endif %} step">
                                <div class="content">
                                    {% if prog < 0 %}
                                        <div class="title" style="text-decoration: line-through">{{s}}</div>
                                        {% if item.deployment.project.isUserNameAllowed(app.user().username, item.deployment.project.item_statuses[s].role) %}
                                            <div class="ui button" onclick="changeStatus({{s|json_encode|e('html_attr')}}, true)">
                                                Revert
                                            </div>
                                        {% endif %}
                                    {% else %}
                                        <div class="title">{{s}}</div>
                                        {% if prog == 0 and item.deployment.project.isUserNameAllowed(app.user().username, item.deployment.project.item_statuses[s].role) %}
                                            <div class="description">
                                                <div class="ui primary button" onclick="changeStatus({{item.nextStatus()|json_encode|e('html_attr')}})">
                                                    Proceed</div>
                                                    {% if item.deployment.project.item_statuses[s].rejectaction %}
                                                    <div class="ui button" onclick="changeStatus({{item.deployment.project.item_statuses[s].rejectaction|json_encode|e('html_attr')}}, true)">
                                                        {{item.deployment.project.item_statuses[s].rejectaction}}
                                                    </div>
                                                {% endif %}
                                            </div>
                                        {% endif %}
                                    {% endif %}
                                </div>
                            </div>
                        {% endfor %}

                    </div>
                </div>
                <div class="ui bottom attached segment tab" data-tab="status-log">
                    <table class="ui very compact small sortable table">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Status</th>
                                <th>By</th>
                            </tr>
                        </thead>					
                        <tbody>
                            {% for log in item.status_logs %}
                                <tr>
                                    <td>
                                        <i class="calendar icon"></i>{{log.created_date|date('Y-m-d')}}
                                        <i class="clock icon"></i>{{log.created_date|date('H:i')}}
                                    </td>
                                    <td>{{log.status}}</td>
                                    <td>{{log.created_by.shortname}}</td>
                                </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <div class="eight wide column">
            <h2 class="ui header">
                <span>
                    <i class="ui add to cart icon"></i> Activities
                </span>
                {% if editable %}
                    <a class="ui right floated primary button no-print" href="{{app.path('activity_create',params)}}">
                        <i class="ui plus icon"></i>Add activity
                    </a>
                {% endif %}
            </h2>

            <table class="ui celled striped table">
                <thead>
                    <tr>
                        <th class="ui collapsing">#</th>
                        <th>Template</th>
                        <th colspan="2">Description</th>
                    </tr>
                </thead>
                <tbody>
                    {% for activity in item.activities %}
                        {% set description = activity.template.templateClass().describeActivityAsArray(activity) %}
                        <tr>
                            <td class="ui top aligned collapsing">{{loop.index}}</td>
                            <td class="ui top aligned">
                                {% if activity.stage < 0 %}
                                    <em>Pre Deployment &raquo;</em><br />
                                {% elseif activity.stage > 0 %}
                                    <em>Post Deployment &raquo;</em><br />
                                {% endif %}
                                {{activity.template.title}}
                            </td>
                            <td class="ui top aligned" style="max-width: 600px; overflow-x: auto;">
                                <div style="max-height: 400px; overflow-y: auto;">
                                    {{ r.arrayTable(description) }}
                                </div>
                            </td>
                            <td class="ui top aligned collapsing no-print">
                                <div>{{activity.runitem.status|default('New')}}</div>
                                {% if editable and (not activity.runitem or activity.runitem.status != 'Completed') %}
                                    <a class="ui icon button" title="Edit" href="{{app.path('activity_edit',controller.entityParams(activity))}}">
                                        <i class="ui pencil icon"></i>
                                    </a>
                                {% endif %}
                            </td>
                        </tr>
                    {% else %}
                        <tr>
                            <td colspan="1000" class="center aligned">No activity has been defined</td>
                        </tr>
                    {% endfor %}
                </tbody>
            </table>

            <h2 class="ui header">
                <span>
                    <i class="ui attach icon"></i> Attachments
                </span>
                {% if editable %}
                    <a class="ui right floated primary button no-print" href="{{app.path('attachment_create',params)}}">
                        <i class="ui plus icon"></i>Add attachment
                    </a>
                {% endif %}
            </h2>

            <table class="ui celled striped table">
                <thead>
                    <tr>
                        <th class="ui collapsing">#</th>
                        <th>File Name &amp; Type</th>
                        <th>Description</th>
                        <th class="ui collapsing">File Size</th>
                            {% if editable %}
                            <th class="ui collapsing no-print">Action</th>
                            {% endif %}
                    </tr>
                </thead>
                <tbody>
                    {% for attachment in item.attachments %}
                        <tr>
                            <td class="ui collapsing">{{loop.index}}</td>
                            <td>
                                <a title="Download" href="{{app.path('attachment_download',controller.entityParams(attachment))}}">
                                    <strong>{{attachment.filename}}</strong>
                                </a>
                                <div>
                                    <small>{{attachment.filestore.mime_type}}</small>
                                </div>
                            </td>
                            <td>{{attachment.description}}</td>
                            <td class="ui collapsing">{{attachment.filestore.filesize}}</td>
                            {% if editable %}
                                <td class="ui collapsing no-print">
                                    <a class="ui icon button" title="Edit" href="{{app.path('attachment_edit',controller.entityParams(attachment))}}">
                                        <i class="ui pencil icon"></i>
                                    </a>
                                </td>
                            {% endif %}
                        </tr>
                    {% else %}
                        <tr>
                            <td colspan="1000" class="center aligned">No attachment has been uploaded</td>
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        <div class="four wide column">
            <div class="ui secondary segment">
                <h3 class="ui dividing header">
                    <i class="ui comments outline icon"></i> Comments
                </h3>

                <div class="ui comments">
                    {% for comment in item.comments %}
                        <div class="comment">
                            <div class="content">
                                {% if comment.created_by == app.userEntity() and comment.event is empty %}
                                    {% if comment.deleted_date %}
                                        <a class="ui right floated compact very tiny icon button" 
                                           href="{{app.path('item_comment_undelete',controller.entityParams(item)+{'comment':comment.id})}}" title="Undo delete"><i class="ui undo icon"></i>
                                        </a>
                                    {% else %}
                                        <a class="ui right floated compact very tiny icon button" 
                                           href="{{app.path('item_comment_delete',controller.entityParams(item)+{'comment':comment.id})}}" title="Delete"><i class="ui x icon"></i>
                                        </a>
                                    {% endif %}
                                {% endif %}
                                <a class="author">{{comment.created_by.getName()}}</a>
                                <div class="metadata">
                                    <span class="date">{{comment.created_date|date('d/m/Y h:ia')}}</span>
                                </div>
                                {% if comment.event %}
                                    <div class="text">
                                        <span class="ui right pointing label">{{comment.event}}</span> {{comment.text|nl2br}}
                                    </div>
                                {% elseif comment.deleted_date %}
                                    <div class="metadata">
                                        <em>&raquo; Deleted on {{comment.deleted_date|date('d/m/Y h:ia')}}</em>
                                    </div>
                                {% else %}
                                    <div class="text">
                                        {{comment.text|nl2br}}
                                    </div>
                                {% endif %}	
                            </div>
                        </div>
                    {% else %}
                        <em>No comments yet</em>
                    {% endfor %}
                    {% if is_acl_execute %}
                        <form class="ui center aligned form basic segment no-print" method="POST" action="{{app.path('item_comment_add',controller.entityParams(item))}}">
                            <h4 class="ui horizontal divider header">
                                Add comment
                            </h4>
                            <div class="field">
                                <textarea name="text" rows="3"></textarea>
                            </div>
                            <input class="ui secondary button" type="submit" name="_action" value="Post" />
                        </form>
                    {% endif %}
                </div>			
            </div>
        </div>

    </div>

    <script>
        $(function () {
        $('.menu .item')
                .tab();
        });
    </script>

    <div id="change_status_confirmation" class="ui modal">
        <i class="close icon"></i>
        <div class="header">
            Change Status to <span id="change_status_next">next</span>
        </div>
        <form class="ui form basic segment" method="POST" action="{{app.path('item_change_status',params)}}">
            <div id="changeStatusRemarkField" class="ui field content">
                <label>Remark</label>
                <textarea placeholder="Please enter a remark" name="remark"></textarea>
            </div>
            <div class="actions">
                <input class="ui ok primary button" type="submit" value="Change Status" />
                <div class="ui cancel button">Cancel</div>
                <input id="changeStatusRemarkRequired" type="hidden" name="remark_required" value="" />
                <input id="change_status_field" type="hidden" name="new_status" value="" />
            </div>
        </form>
    </div>
{% endblock %}

{% macro changeStatus(v, i) %}
    <div class="ui left labeled button" tabindex="0" style="margin:5px">
        <a class="ui basic right pointing label">
            {% if i.class is defined %}Change{% else %}Revert{% endif %}
        </a>
        <div class="ui {{i.class|default(null)}} button" onclick="changeStatus({{v|json_encode|e('html_attr')}})">
            <i class="{{i.icon}} icon"></i> {{v}}
        </div>
    </div>
{% endmacro %}

{% macro changeStatusBox(next_status) %}
    {% import _self as mm %}
    {% if next_status|length > 0 %}
        <div class="ui info message">
            {% for v,i in next_status %}
                {{mm.changeStatus(v, i)}}<br />
            {% endfor %}
        </div>
    {% endif %}
{% endmacro %}